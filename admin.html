<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Admin Koleksiku ‚Äì Shopee & TikTok</title>
  <style>
    body{
      background:#0b1622;
      color:#e5e7eb;
      font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
      padding:20px;
    }
    .wrap{max-width:720px;margin:0 auto;}
    h1{margin:0 0 6px;text-align:center;}
    .sub{text-align:center;font-size:13px;color:#9ca3af;margin-bottom:18px;}

    .tabs{
      display:flex;
      background:#111827;
      border-radius:999px;
      overflow:hidden;
      margin-bottom:16px;
      border:1px solid #1f2937;
    }
    .tab{
      flex:1;
      text-align:center;
      padding:8px 0;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      color:#9ca3af;
      user-select:none;
    }
    .tab.active{
      background:#f97316;
      color:#fff;
    }

    .panel{display:none;}
    .panel.active{display:block;}

    .box{
      background:#111827;
      border-radius:12px;
      padding:14px;
      border:1px solid #1f2937;
      box-shadow:0 4px 15px rgba(0,0,0,.4);
      margin-bottom:16px;
    }
    .box h2{margin:0 0 6px;font-size:16px;}
    .box p{margin:4px 0 10px;font-size:13px;color:#cbd5f5;}

    textarea{
      width:100%;
      height:120px;
      background:#020617;
      color:#e5e7eb;
      border-radius:8px;
      border:1px solid #1f2937;
      padding:8px;
      font-size:13px;
      resize:vertical;
    }
    button{
      margin-top:8px;
      padding:9px 16px;
      border-radius:999px;
      border:none;
      background:#f97316;
      color:#fff;
      font-weight:600;
      font-size:13px;
      cursor:pointer;
    }
    button:hover{background:#fb923c;}
    button:disabled{
      opacity:.6;
      cursor:not-allowed;
    }

    #log{
      margin-top:18px;
      background:#020617;
      border-radius:8px;
      border:1px solid #1f2937;
      padding:10px;
      height:220px;
      overflow-y:auto;
      font-family:ui-monospace,Menlo,Consolas,monospace;
      font-size:12px;
      white-space:pre-line;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Admin Koleksiku</h1>
    <div class="sub">Tambah Shopee & TikTok ‚Üí langsung nulis ke Sheet ‚Äúdata‚Äù</div>

    <div class="tabs">
      <div id="tab-shopee" class="tab active" onclick="setTab('shopee')">üõí Shopee</div>
      <div id="tab-tiktok" class="tab" onclick="setTab('tiktok')">üéµ TikTok</div>
    </div>

    <!-- Shopee -->
    <div id="panel-shopee" class="panel active">
      <div class="box">
        <h2>üõí Tambah link Shopee</h2>
        <p>Tempel link Shopee <b>1 per baris</b>. Sistem akan ambil judul & gambar otomatis.</p>
        <textarea id="shopee-links" placeholder="https://s.shopee.co.id/xxx
https://s.shopee.co.id/yyy"></textarea>
        <button id="btnShopee" onclick="kirimShopee()">Kirim Shopee ke Sheet</button>
      </div>
    </div>

    <!-- TikTok -->
    <div id="panel-tiktok" class="panel">
      <div class="box">
        <h2>üéµ Tambah link TikTok</h2>
        <p>Tempel link TikTok <b>1 per baris</b>. Sistem akan coba ambil judul & thumbnail.</p>
        <textarea id="tiktok-links" placeholder="https://www.tiktok.com/@user/video/...
https://vt.tiktok.com/xxx"></textarea>
        <button id="btnTikTok" onclick="kirimTikTok()">Kirim TikTok ke Sheet</button>
      </div>
    </div>

    <div id="log">Log siap‚Ä¶</div>
  </div>

  <script>
    // ‚úÖ URL WebApp (Apps Script). Pastikan ini URL deploy TERBARU.
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwVed58VCwLccuYlLhHTvWoehPB2bVq4r352bbFFTWUzFdKAe2N2jV-vp6wAsuKUxFL/exec";

    function setTab(which){
      document.getElementById("tab-shopee").classList.toggle("active", which === "shopee");
      document.getElementById("tab-tiktok").classList.toggle("active", which === "tiktok");
      document.getElementById("panel-shopee").classList.toggle("active", which === "shopee");
      document.getElementById("panel-tiktok").classList.toggle("active", which === "tiktok");
    }

    function log(msg){
      const el = document.getElementById("log");
      el.textContent += "\n" + msg;
      el.scrollTop = el.scrollHeight;
    }

    function setLog(msg){
      const el = document.getElementById("log");
      el.textContent = msg;
      el.scrollTop = el.scrollHeight;
    }

    function parseLines(textareaId){
      const raw = document.getElementById(textareaId).value.trim();
      if (!raw) return [];
      return raw.split(/\r?\n/)
        .map(s => s.trim())
        .filter(Boolean);
    }

    function setBusy(btnId, busy){
      const btn = document.getElementById(btnId);
      if (!btn) return;
      btn.disabled = !!busy;
      btn.textContent = busy ? "‚è≥ Memproses..." : (btnId === "btnShopee" ? "Kirim Shopee ke Sheet" : "Kirim TikTok ke Sheet");
    }

    async function postToWebApp(payload){
      // ‚úÖ Tanpa no-cors supaya kita bisa baca response JSON
      const res = await fetch(WEBAPP_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      // Apps Script kadang balikin 200 tapi text bukan JSON kalau error.
      const text = await res.text();
      let data;
      try {
        data = JSON.parse(text);
      } catch (e) {
        throw new Error("Response bukan JSON. Isi response:\n" + text.slice(0, 400));
      }
      return data;
    }

    async function kirimShopee(){
      setLog("‚è≥ Mulai proses Shopee...\n");
      const list = parseLines("shopee-links");
      if (!list.length){
        alert("Isi dulu link Shopee-nya bro.");
        return;
      }

      setBusy("btnShopee", true);
      log("Total link Shopee: " + list.length);
      log("Kirim ke WebApp...");

      try {
        // ‚úÖ payload aman sesuai backend baru
        const data = await postToWebApp({ type: "shopee", links: list });

        if (!data.ok) {
          throw new Error(data.error || "Unknown error dari WebApp");
        }

        log("‚úÖ Sukses: " + data.count + " link masuk.");
        if (Array.isArray(data.results)) {
          data.results.forEach((r, idx) => {
            const title = r.name || "Produk";
            const imgOk = r.image && !String(r.image).includes("via.placeholder.com");
            log(`${idx+1}. ${imgOk ? "üñºÔ∏è" : "‚ö†Ô∏è"} ${title} | ${r.finalUrl || r.inputUrl}`);
          });
        }

        log("\nüéâ Selesai. Cek sheet 'data' (hasil harus kayak row 1‚Äì29).");

        // ‚úÖ opsional: clear textarea setelah sukses
        document.getElementById("shopee-links").value = "";

      } catch(e){
        log("‚ùå ERROR Shopee: " + (e?.message || e));
        alert("ERROR Shopee:\n" + (e?.message || e));
      } finally {
        setBusy("btnShopee", false);
      }
    }

    async function kirimTikTok(){
      setLog("‚è≥ Mulai proses TikTok...\n");
      const list = parseLines("tiktok-links");
      if (!list.length){
        alert("Isi dulu link TikTok-nya bro.");
        return;
      }

      setBusy("btnTikTok", true);
      log("Total link TikTok: " + list.length);
      log("Kirim ke WebApp...");

      try {
        // TikTok: tetap lewat webapp biar bisa dikembangkan nanti
        const data = await postToWebApp({ type: "tiktok", links: list });

        if (!data.ok) {
          throw new Error(data.error || "Unknown error dari WebApp");
        }

        log("‚úÖ Sukses: " + data.count + " link masuk.");
        if (Array.isArray(data.results)) {
          data.results.forEach((r, idx) => {
            const title = r.name || "Konten";
            log(`${idx+1}. üéµ ${title} | ${r.finalUrl || r.inputUrl}`);
          });
        }

        log("\nüéâ Selesai. Cek sheet 'data' apakah baris TikTok sudah masuk.");

        // opsional clear
        document.getElementById("tiktok-links").value = "";

      } catch(e){
        log("‚ùå ERROR TikTok: " + (e?.message || e));
        alert("ERROR TikTok:\n" + (e?.message || e));
      } finally {
        setBusy("btnTikTok", false);
      }
    }
  </script>
</body>
</html>
